<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendário Letivo 2026 - Editor</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <!-- Tela de login (aparece primeiro) -->
    <div
      id="loginScreen"
      style="
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      "
    >
      <div class="modal-content" style="width: 400px">
        <div style="text-align: center; margin-bottom: 20px">
          <!-- NOVO: Logomarca no login -->
          <img
            id="login-logo"
            src=""
            alt="Logomarca da Escola"
            style="
              max-height: 60px;
              max-width: 150px;
              margin-bottom: 15px;
              display: none;
            "
          />
          <h2>Acesso ao Editor</h2>
          <div
            id="login-school-name"
            style="
              color: var(--gray-600);
              margin-bottom: 10px;
              font-size: 0.9rem;
            "
          >
            <!-- Nome da escola será inserido aqui -->
          </div>
        </div>
        <p style="margin-bottom: 20px; color: var(--gray-600)">
          Digite a senha para acessar o modo de edição:
        </p>

        <label for="editorPassword">Senha:</label>
        <input
          type="password"
          id="editorPassword"
          placeholder="Digite a senha"
          style="margin-bottom: 15px"
        />

        <div class="modal-actions">
          <button id="loginButton">Entrar</button>
          <button id="backButton" onclick="window.location.href='index.html'">
            Voltar para Visualização
          </button>
        </div>

        <p
          id="loginError"
          style="color: var(--danger); margin-top: 15px; display: none"
        >
          Senha incorreta. Tente novamente.
        </p>

        <p style="font-size: 0.8rem; color: var(--gray-500); margin-top: 20px">
          Senha padrão: admin123<br />
          (Você pode alterar no arquivo auth.js)
        </p>
      </div>
    </div>

    <!-- Conteúdo do editor (aparece após login) -->
    <div id="editorContent" style="display: none">
      <!-- NOVO: Container para logomarca e título no editor -->
      <div id="header-container">
        <div id="logo-container">
          <img
            id="school-logo"
            src=""
            alt="Logomarca da Escola"
            style="display: none"
          />
        </div>
        <div id="title-container">
          <h1 id="main-title">Calendário Letivo 2025/2026 - Editor</h1>
          <div
            id="school-name"
            style="
              display: none;
              margin-top: 5px;
              font-size: 1.1rem;
              color: var(--gray-600);
            "
          >
            <!-- Nome da escola será inserido aqui -->
          </div>
        </div>
      </div>

      <div id="totals">
        <h2>Ano Letivo 2026</h2>

        <div class="total-display">
          <div>
            <div class="total-main" id="totalAnoAtual">0</div>
            <div class="total-label">dias letivos de 200</div>
          </div>

          <div class="total-progress">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0%</div>
          </div>
        </div>

        <div class="info-cards">
          <div class="info-card" id="inicioAnoLetivo">
            <strong>Início</strong>
            <span>09 de Fevereiro 2026</span>
          </div>
          <div class="info-card" id="fimAnoLetivo">
            <strong>Fim</strong>
            <span>Não definido</span>
          </div>
        </div>
      </div>

      <div id="buttons">
        <div class="button-row">
          <button id="toggleEditMode">Ativar Modo de Edição</button>
          <button id="resetCalendar">Resetar</button>
          <button id="exportJSON">Exportar JSON</button>
          <button id="importJSON">Importar JSON</button>
          <button id="exportPDF">Exportar PDF</button>
          <button id="goToViewer">Voltar para Visualização</button>
          <button id="logoutButton">Sair do Editor</button>
          <input type="file" id="jsonFileInput" style="display: none" />
        </div>
      </div>

      <div id="editModeIndicator">Modo de Edição Ativo</div>

      <div id="yearCalendar"></div>

      <!-- Modal de edição do dia -->
      <div id="dayModal" class="modal">
        <div class="modal-content">
          <span id="closeDayModal" class="close">&times;</span>
          <h2 id="modalDayTitle"></h2>

          <label>Tipo do dia:</label>
          <select id="dayType">
            <option value="comum">Dia Letivo</option>
            <option value="evento">Evento Escolar</option>
            <option value="avaliacao">Avaliação</option>
            <option value="sabado_letivo">Sábado Letivo</option>
            <option value="feriado">Feriado</option>
            <option value="recesso">Recesso (Todos os funcionários)</option>
            <option value="recesso_professores">Recesso dos Professores</option>
            <option value="ferias">Férias</option>
            <option value="paralisacao">Paralisação</option>
            <option value="recuperacao">Recuperação Final</option>
            <option value="personalizado">Personalizado</option>
          </select>

          <!-- NOVO: Seletor de cor personalizada -->
          <div style="margin: 15px 0">
            <label style="display: block; margin-bottom: 8px; font-weight: 600">
              Cor do dia:
              <span
                id="currentColorPreview"
                style="
                  display: inline-block;
                  width: 20px;
                  height: 20px;
                  margin-left: 10px;
                  vertical-align: middle;
                  border: 1px solid var(--gray-300);
                  border-radius: 4px;
                "
              ></span>
            </label>
            <div
              style="
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                margin-bottom: 10px;
              "
            >
              <!-- Cores padrão -->
              <div
                class="color-option"
                data-color="#7bbf7d"
                title="Dia Letivo"
                style="background-color: #7bbf7d"
              ></div>
              <div
                class="color-option"
                data-color="#77b5fe"
                title="Evento Escolar"
                style="background-color: #77b5fe"
              ></div>
              <div
                class="color-option"
                data-color="#a3d17a"
                title="Sábado Letivo"
                style="background-color: #a3d17a"
              ></div>
              <div
                class="color-option"
                data-color="#7986cb"
                title="Avaliação"
                style="background-color: #7986cb"
              ></div>
              <div
                class="color-option"
                data-color="#ba68c8"
                title="Feriado"
                style="background-color: #ba68c8"
              ></div>
              <div
                class="color-option"
                data-color="#ffb74d"
                title="Recesso"
                style="background-color: #ffb74d"
              ></div>
              <div
                class="color-option"
                data-color="#ff8a65"
                title="Recesso Professores"
                style="background-color: #ff8a65"
              ></div>
              <div
                class="color-option"
                data-color="#ff8a80"
                title="Férias"
                style="background-color: #ff8a80"
              ></div>
              <div
                class="color-option"
                data-color="#a1887f"
                title="Paralisação"
                style="background-color: #a1887f"
              ></div>
              <div
                class="color-option"
                data-color="#ffd54f"
                title="Recuperação"
                style="background-color: #ffd54f"
              ></div>
            </div>

            <!-- Seletor de cor personalizado -->
            <div style="display: flex; gap: 10px; align-items: center">
              <input
                type="color"
                id="dayColorPicker"
                value="#7bbf7d"
                style="width: 60px; height: 40px"
              />
              <input
                type="text"
                id="dayColorInput"
                placeholder="#HEX ou nome"
                style="
                  flex: 1;
                  padding: 8px;
                  border: 1px solid var(--gray-300);
                  border-radius: 6px;
                "
              />
              <button
                id="applyCustomColor"
                style="padding: 8px 12px; font-size: 0.8rem"
              >
                Aplicar
              </button>
            </div>
            <div
              style="font-size: 0.8rem; color: var(--gray-500); margin-top: 5px"
            >
              Clique nas cores acima ou use o seletor personalizado
            </div>
          </div>

          <label>Título:</label>
          <input type="text" id="dayTitle" />

          <label>Descrição:</label>
          <textarea id="dayDescription"></textarea>

          <!-- Checkbox para contar como dia letivo -->
          <div
            style="
              margin: 15px 0;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            <input type="checkbox" id="dayCountAsLetivo" style="width: auto" />
            <label for="dayCountAsLetivo" style="margin: 0; font-weight: 600">
              Contar como dia letivo (para os 200 dias)
            </label>
          </div>

          <div class="modal-actions">
            <button id="saveDay">Salvar</button>
            <button id="deleteDay" class="danger">Apagar Evento</button>
          </div>
        </div>
      </div>

      <!-- Modal de edição do mês -->
      <div id="monthModal" class="modal">
        <div class="modal-content">
          <span id="closeMonthModal" class="close">&times;</span>
          <h2 id="modalMonthTitle"></h2>

          <label>Nome do mês:</label>
          <input type="text" id="monthName" />

          <label>Descrição:</label>
          <textarea id="monthDesc"></textarea>

          <label>Observações:</label>
          <textarea id="monthNotes"></textarea>

          <label>Meta de dias letivos:</label>
          <input type="number" id="monthTarget" />

          <div class="modal-actions">
            <button id="saveMonth">Salvar Mês</button>
          </div>
        </div>
      </div>

      <!-- Modal de visualização do mês em tamanho grande -->
      <div id="monthViewModal" class="modal">
        <div
          class="modal-content"
          style="
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
          "
        >
          <span id="closeMonthViewModal" class="close">&times;</span>
          <h2 id="monthViewTitle"></h2>

          <div
            id="monthViewDescription"
            style="
              margin-bottom: 20px;
              padding: 15px;
              background: var(--gray-50);
              border-radius: 8px;
            "
          ></div>

          <div
            id="monthViewGrid"
            style="
              display: grid;
              grid-template-columns: repeat(7, 1fr);
              gap: 1px;
              background: var(--gray-200);
              padding: 1px;
            "
          >
            <!-- Os dias serão inseridos aqui via JavaScript -->
          </div>

          <div
            style="
              margin-top: 20px;
              padding-top: 15px;
              border-top: 1px solid var(--gray-200);
            "
          >
            <div
              id="monthViewNotes"
              style="font-size: 0.9rem; color: var(--gray-600)"
            ></div>
            <div
              id="monthViewTarget"
              style="
                font-size: 0.9rem;
                color: var(--gray-600);
                margin-top: 10px;
              "
            ></div>
          </div>

          <div class="modal-actions" style="margin-top: 20px">
            <button id="printMonthView">Imprimir Visualização</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase SDKs (Compat) -->
    <script>
      // ---------- CONFIGURE AQUI ----------
      // Cole aqui o mesmo FIREBASE_CONFIG do index.html
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBoJ0fleRy89A5m43Giu-M17qbbTSOYopk",
        authDomain: "calendario-letivo-6c027.firebaseapp.com",
        projectId: "calendario-letivo-6c027",
        storageBucket: "calendario-letivo-6c027.firebasestorage.app",
        messagingSenderId: "953319249148",
        appId: "1:953319249148:web:f35074ab1303131187b379",
      };
      window.FIREBASE_CONFIG = FIREBASE_CONFIG;

      // NOVO: Configuração da Escola (mesmo do index.html)
      const SCHOOL_CONFIG = {
        name: "Nome da Escola", // Altere para o nome da escola
        logo: "logo.png", // Nome do arquivo da logo (logo.png ou logo.jpg)
        logoAlt: "Logomarca da Escola", // Texto alternativo para acessibilidade
        showInPDF: true, // Se true, a logo aparecerá no PDF exportado
      };
      window.SCHOOL_CONFIG = SCHOOL_CONFIG;
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <!-- Biblioteca jsPDF e html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="script.js"></script>
    <script src="auth.js"></script>
    <script>
      // Configuração específica para a página de editor
      document.addEventListener("DOMContentLoaded", async function () {
        // Inicializar Firebase (se configurado)
        if (
          window.FIREBASE_CONFIG &&
          Object.keys(window.FIREBASE_CONFIG).length
        ) {
          initFirebase(); // function from script.js
        }

        // NOVO: Carregar logomarca da escola
        loadSchoolLogo();
        loadSchoolLoginLogo();

        // SEMPRE mostrar tela de login primeiro
        document.getElementById("loginScreen").style.display = "flex";
        document.getElementById("editorContent").style.display = "none";

        // Configurar botão de login
        document
          .getElementById("loginButton")
          .addEventListener("click", function () {
            const password = document.getElementById("editorPassword").value;
            const errorElement = document.getElementById("loginError");

            if (checkPassword(password)) {
              // Salvar login apenas para esta sessão
              saveLogin();
              showEditor();
            } else {
              errorElement.style.display = "block";
              document.getElementById("editorPassword").value = "";
              document.getElementById("editorPassword").focus();
            }
          });

        // Permitir login com Enter
        document
          .getElementById("editorPassword")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              document.getElementById("loginButton").click();
            }
          });

        // Botão para voltar à visualização
        document
          .getElementById("goToViewer")
          .addEventListener("click", function () {
            // Não fazer logout, apenas redirecionar
            window.location.href = "index.html";
          });

        // Botão para sair do editor (logout)
        document
          .getElementById("logoutButton")
          .addEventListener("click", function () {
            if (confirm("Deseja realmente sair do modo de edição?")) {
              logout();
            }
          });

        // Configurar botão de imprimir visualização do mês
        document
          .getElementById("printMonthView")
          .addEventListener("click", function () {
            window.print();
          });

        // Fechar modais ao clicar fora
        window.addEventListener("click", function (event) {
          const dayModal = document.getElementById("dayModal");
          const monthModal = document.getElementById("monthModal");
          const monthViewModal = document.getElementById("monthViewModal");

          if (event.target === dayModal) {
            dayModal.style.display = "none";
          }
          if (event.target === monthModal) {
            monthModal.style.display = "none";
          }
          if (event.target === monthViewModal) {
            monthViewModal.style.display = "none";
          }
        });
      });

      function showEditor() {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("editorContent").style.display = "block";

        // Inicializar calendário em modo de edição
        editMode = true;
        initCalendar();

        // Ativar indicador de modo de edição
        const indicator = document.getElementById("editModeIndicator");
        indicator.classList.add("active");
        indicator.innerHTML =
          "✏️ MODO DE EDIÇÃO ATIVO - Clique nos dias para editar";

        // Configurar botão de alternar modo
        const toggleBtn = document.getElementById("toggleEditMode");
        toggleBtn.textContent = "Desativar Modo de Edição";

        // Configurar sessão (para logout automático após tempo)
        setupSession();
      }

      // NOVA FUNÇÃO: Carregar logomarca da escola para o editor
      function loadSchoolLogo() {
        const schoolConfig = window.SCHOOL_CONFIG || {};
        const logoElement = document.getElementById("school-logo");
        const schoolNameElement = document.getElementById("school-name");
        const mainTitleElement = document.getElementById("main-title");

        // Configurar nome da escola se fornecido
        if (schoolConfig.name && schoolConfig.name !== "Nome da Escola") {
          schoolNameElement.textContent = schoolConfig.name;
          schoolNameElement.style.display = "block";

          // Atualizar título principal para incluir nome da escola
          if (mainTitleElement) {
            mainTitleElement.textContent = `Calendário Letivo 2025/2026 - ${schoolConfig.name} - Editor`;
          }
        }

        // Tentar carregar a logomarca
        if (
          schoolConfig.logo &&
          (schoolConfig.logo === "logo.png" || schoolConfig.logo === "logo.jpg")
        ) {
          logoElement.src = schoolConfig.logo;
          logoElement.alt = schoolConfig.logoAlt || "Logomarca da Escola";

          // Quando a imagem carregar, mostrar e ajustar estilos
          logoElement.onload = function () {
            logoElement.style.display = "block";
            logoElement.style.maxHeight = "80px";
            logoElement.style.maxWidth = "200px";
            logoElement.style.objectFit = "contain";
            logoElement.style.marginRight = "20px";
          };

          // Se a imagem não carregar, tentar alternativas
          logoElement.onerror = function () {
            console.warn(
              `Logomarca "${schoolConfig.logo}" não encontrada. Tentando alternativas...`
            );

            // Tentar com diferentes extensões
            const alternativeExtensions = ["png", "jpg", "jpeg", "svg", "webp"];
            const baseName = schoolConfig.logo.split(".")[0];

            let tryCount = 0;
            const tryNextLogo = () => {
              if (tryCount < alternativeExtensions.length) {
                const altLogo = `${baseName}.${alternativeExtensions[tryCount]}`;
                logoElement.src = altLogo;
                tryCount++;
              } else {
                console.warn(
                  "Nenhuma logomarca encontrada. Usando layout sem logo."
                );
                logoElement.style.display = "none";
              }
            };

            logoElement.onerror = tryNextLogo;
            tryNextLogo();
          };
        } else {
          // Se não houver configuração de logo, esconder o container
          document.getElementById("logo-container").style.display = "none";
        }
      }

      // NOVA FUNÇÃO: Carregar logomarca para a tela de login
      function loadSchoolLoginLogo() {
        const schoolConfig = window.SCHOOL_CONFIG || {};
        const loginLogoElement = document.getElementById("login-logo");
        const loginSchoolNameElement =
          document.getElementById("login-school-name");

        // Configurar nome da escola no login
        if (schoolConfig.name && schoolConfig.name !== "Nome da Escola") {
          loginSchoolNameElement.textContent = schoolConfig.name;
        }

        // Tentar carregar a logomarca para o login
        if (
          schoolConfig.logo &&
          (schoolConfig.logo === "logo.png" || schoolConfig.logo === "logo.jpg")
        ) {
          loginLogoElement.src = schoolConfig.logo;
          loginLogoElement.alt = schoolConfig.logoAlt || "Logomarca da Escola";

          // Quando a imagem carregar, mostrar
          loginLogoElement.onload = function () {
            loginLogoElement.style.display = "inline-block";
          };

          // Se a imagem não carregar, tentar alternativas
          loginLogoElement.onerror = function () {
            console.warn(
              `Logomarca "${schoolConfig.logo}" não encontrada para login. Tentando alternativas...`
            );

            // Tentar com diferentes extensões
            const alternativeExtensions = ["png", "jpg", "jpeg", "svg", "webp"];
            const baseName = schoolConfig.logo.split(".")[0];

            let tryCount = 0;
            const tryNextLogo = () => {
              if (tryCount < alternativeExtensions.length) {
                const altLogo = `${baseName}.${alternativeExtensions[tryCount]}`;
                loginLogoElement.src = altLogo;
                tryCount++;
              } else {
                console.warn("Nenhuma logomarca encontrada para login.");
                loginLogoElement.style.display = "none";
              }
            };

            loginLogoElement.onerror = tryNextLogo;
            tryNextLogo();
          };
        }
      }
    </script>
  </body>
</html>
